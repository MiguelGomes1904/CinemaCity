<!DOCTYPE html>
<html>
<head>
    <title>Booking Bar Debug</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 20px; color: #333; }
        .booking-bar { 
            display: flex; 
            gap: 15px; 
            margin: 30px 0;
            flex-wrap: wrap;
            padding: 20px;
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }
        select, input, button { 
            padding: 12px 15px; 
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        input { flex: 1; min-width: 150px; }
        button {
            padding: 12px 30px;
            background: #ff6b35;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { background: #e55a2b; }
        .log { 
            margin-top: 30px; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #00ff00;
            border-radius: 4px;
            border: 1px solid #333;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.4;
        }
        .status { 
            margin: 15px 0;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ Cinema City - Booking Bar Debug</h1>
        
        <div id="status" class="status info">Carregando...</div>
        
        <section class="booking-bar">
            <select id="cinema"><option>Escolha um Cinema</option></select>
            <select id="movie"><option>Escolha um Filme</option></select>
            <select id="date"><option>Data</option></select>
            <select id="time"><option>Hora</option></select>
            <button id="buy">Comprar bilhetes</button>
        </section>

        <div class="log" id="log">Inicializando...</div>
    </div>

    <script>
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');
        let logMessages = [];
        
        function updateLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}`;
            logMessages.push(line);
            logElement.textContent = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            console.log(line);
        }

        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // Test stage 1: Check API endpoints
        updateLog('=== Stage 1: Testando APIs ===');
        
        Promise.all([
            fetch('/CinemaCity/api/list-movies.php')
                .then(r => {
                    updateLog(`Movies API Status: ${r.status} ${r.statusText}`);
                    return r.json();
                })
                .then(data => {
                    updateLog(`Movies Count: ${data.count || data.length || 'unknown'}`);
                    if (data.success) {
                        updateLog(`âœ“ Movies loaded: ${data.movies?.length || 'N/A'} filmes`);
                        return { success: true, movies: data.movies || [] };
                    }
                    return data;
                })
                .catch(e => {
                    updateLog(`âœ— Movies API Error: ${e.message}`, 'error');
                    return { success: false, error: e.message };
                }),
            
            fetch('/CinemaCity/api/list-sessions.php')
                .then(r => {
                    updateLog(`Sessions API Status: ${r.status} ${r.statusText}`);
                    return r.json();
                })
                .then(data => {
                    updateLog(`Sessions Count: ${data.count || 'unknown'}`);
                    if (data.success) {
                        updateLog(`âœ“ Sessions loaded: ${data.sessions?.length || 'N/A'} sessÃµes`);
                        return { success: true, sessions: data.sessions || [] };
                    }
                    return data;
                })
                .catch(e => {
                    updateLog(`âœ— Sessions API Error: ${e.message}`, 'error');
                    return { success: false, error: e.message };
                })
        ]).then(([moviesRes, sessionsRes]) => {
            updateLog('\n=== Stage 2: Verificando dados ===');
            
            if (moviesRes.success && sessionsRes.success) {
                updateLog(`âœ“ Todas as APIs responderam com sucesso`);
                updateLog(`  - ${moviesRes.movies.length} filmes`);
                updateLog(`  - ${sessionsRes.sessions.length} sessÃµes`);
                
                // Extract cinemas
                const cinemas = new Set();
                sessionsRes.sessions.forEach(s => {
                    if (s.cinema_name) cinemas.add(s.cinema_name);
                });
                updateLog(`  - ${cinemas.size} cinemas encontrados: ${Array.from(cinemas).join(', ')}`);
                
                updateStatus('âœ“ Booking Bar ready!', 'success');
            } else {
                updateStatus('âœ— Erro ao carregar dados', 'error');
            }
            
            updateLog('\n=== Stage 3: Carregando booking-bar.js ===');
            updateLog('Aguardando script externo...');
        });

        // Override console to capture logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            updateLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
        };
    </script>
    
    <script src="/CinemaCity/assets/js/booking-bar.js"></script>
</body>
</html>
